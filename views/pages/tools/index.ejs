<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Developer Tools | DVLCube</title>
    <!-- Materialize CSS -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/tools.css">
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-wrapper">
            <a href="/" class="brand-logo" style="margin-left: 20px;">
                <i class="material-icons">build</i>
                DVLCube Tools
            </a>
            <ul id="nav-mobile" class="right hide-on-med-and-down">
                <li><a href="/">Home</a></li>
                <li><a href="https://github.com/dvlcube" target="_blank"><i class="material-icons left">code</i>GitHub</a></li>
            </ul>
        </div>
    </nav>

    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <ul class="collection">
                <% for (const [key, category] of Object.entries(routeMetadata)) { %>
                <li class="collection-item" data-category="<%= key %>" onclick="selectCategory('<%= key %>')">
                    <div class="valign-wrapper">
                        <i class="material-icons category-icon"><%= category.icon %></i>
                        <div>
                            <span class="category-name"><%= category.name %></span>
                            <span class="category-desc"><%= category.description %></span>
                        </div>
                    </div>
                </li>
                <% } %>
            </ul>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <div class="tools-panel">
                <!-- Welcome Panel (shown when no category selected) -->
                <div id="welcome-panel" class="welcome-panel">
                    <i class="material-icons large-icon">handyman</i>
                    <h4>Welcome to Developer Tools</h4>
                    <p>Select a category from the sidebar to get started. Each tool allows you to generate, validate, or encode data quickly and easily.</p>
                </div>

                <!-- Dynamic Content Area -->
                <div id="tools-content" style="display: none;">
                    <div class="category-header">
                        <h4 id="category-title"><i class="material-icons" id="category-icon"></i><span id="category-name"></span></h4>
                        <p id="category-description"></p>
                    </div>
                    <div id="routes-container"></div>
                </div>
            </div>

            <!-- Ad Sidebar -->
            <div class="ad-sidebar">
                <div class="ad-container">
                    <div class="ad-placeholder large">
                        <span>Ad Space<br>300 x 250</span>
                    </div>
                </div>
                <div class="ad-container">
                    <div class="ad-placeholder banner">
                        <span>Ad Space - 300 x 90</span>
                    </div>
                </div>
                
                <!-- History Panel -->
                <div class="history-panel" id="history-panel" style="display: none;">
                    <h6><i class="material-icons">history</i>Recent Results</h6>
                    <div class="history-list" id="history-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Materialize JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    
    <script>
        // Route metadata from server (embedded as JSON string and parsed at runtime)
        const routeMetadata = JSON.parse('<%- JSON.stringify(routeMetadata) %>');
        
        // History storage
        let resultHistory = [];
        const MAX_HISTORY = 10;

        // Select a category
        function selectCategory(categoryKey, updateHash = true) {
            const category = routeMetadata[categoryKey];
            if (!category) return;

            // Update sidebar active state
            document.querySelectorAll('.sidebar .collection-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-category="${categoryKey}"]`).classList.add('active');

            // Show tools content
            document.getElementById('welcome-panel').style.display = 'none';
            document.getElementById('tools-content').style.display = 'block';

            // Update header
            document.getElementById('category-icon').textContent = category.icon;
            document.getElementById('category-name').textContent = category.name;
            document.getElementById('category-description').textContent = category.description;

            // Render routes
            renderRoutes(category.routes);
            
            // Update URL hash
            if (updateHash) {
                window.location.hash = categoryKey;
            }
        }
        
        // Load category from URL hash
        function loadCategoryFromHash() {
            const hash = window.location.hash.substring(1); // Remove '#'
            if (hash && routeMetadata[hash]) {
                selectCategory(hash, false);
            }
        }
        
        // Handle browser back/forward
        window.addEventListener('hashchange', () => {
            loadCategoryFromHash();
        });

        // Render route cards
        function renderRoutes(routes) {
            const container = document.getElementById('routes-container');
            container.innerHTML = '';

            routes.forEach((route, index) => {
                const card = document.createElement('div');
                card.className = 'route-card';
                card.id = `route-${index}`;

                const isSandbox = route.path.startsWith('/sandbox/');
                const language = isSandbox ? route.path.split('/').pop() : null;

                let paramsHtml = '';
                route.params.forEach(param => {
                    if (param.type === 'select') {
                        paramsHtml += `
                            <div class="input-field">
                                <select id="param-${index}-${param.name}" data-param="${param.name}">
                                    ${param.options.map(opt => `<option value="${opt}" ${opt === param.default ? 'selected' : ''}>${opt}</option>`).join('')}
                                </select>
                                <label>${param.name}${param.required ? ' *' : ''}</label>
                            </div>
                        `;
                    } else if (param.type === 'textarea') {
                        paramsHtml += `
                            <div class="input-field">
                                <textarea id="param-${index}-${param.name}" class="materialize-textarea" data-param="${param.name}" placeholder="${param.placeholder || ''}" ${param.required ? 'required' : ''}></textarea>
                                <label for="param-${index}-${param.name}">${param.name}${param.required ? ' *' : ''}</label>
                            </div>
                        `;
                    } else if (param.type === 'checkbox') {
                        const checkedAttr = param.default === true ? 'checked' : '';
                        paramsHtml += `
                            <p>
                                <label>
                                    <input type="checkbox" id="param-${index}-${param.name}" data-param="${param.name}" ${checkedAttr} />
                                    <span>${param.label || param.name}</span>
                                </label>
                            </p>
                        `;
                    } else {
                        paramsHtml += `
                            <div class="input-field">
                                <input type="text" id="param-${index}-${param.name}" data-param="${param.name}" placeholder="${param.placeholder || ''}" ${param.required ? 'required' : ''}>
                                <label for="param-${index}-${param.name}">${param.name}${param.required ? ' *' : ''}</label>
                            </div>
                        `;
                    }
                });

                // Add saved snippets section and save/clear buttons for sandbox routes
                const snippetControls = isSandbox ? `
                    <div style="margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: 4px; padding: 10px; background: #fafafa;">
                        <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleSnippets(${index})">
                            <strong style="color: #666;"><i class="material-icons" style="vertical-align: middle; font-size: 18px;">snippet_folder</i> Saved Snippets</strong>
                            <i class="material-icons" id="snippets-toggle-${index}" style="color: #999;">expand_more</i>
                        </div>
                        <div id="snippets-list-${index}" style="display: none; margin-top: 10px; max-height: 200px; overflow-y: auto;">
                            <!-- Snippets will be populated here -->
                        </div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <button type="button" class="btn-small waves-effect grey" onclick="saveSnippet(${index}, '${language}')">
                            <i class="material-icons left">save</i>Save Snippet
                        </button>
                        <button type="button" class="btn-small waves-effect grey" onclick="clearTextarea(${index})">
                            <i class="material-icons left">delete</i>Clear
                        </button>
                    </div>
                ` : '';

                card.innerHTML = `
                    <h5>${route.name}</h5>
                    <p class="route-description">${route.description}</p>
                    <div class="route-path">${route.method} ${route.path}</div>
                    <form onsubmit="callRoute(event, ${index}, '${route.path}', ${isSandbox})">
                        ${paramsHtml}
                        ${snippetControls}
                        <button type="submit" class="btn waves-effect waves-light">
                            <i class="material-icons left">send</i>
                            Execute
                            <div class="preloader-wrapper small loading-spinner" id="spinner-${index}">
                                <div class="spinner-layer spinner-white-only">
                                    <div class="circle-clipper left"><div class="circle"></div></div>
                                </div>
                            </div>
                        </button>
                    </form>
                    <div class="result-container" id="result-${index}">
                        <div class="result-box" id="result-box-${index}"></div>
                        <div class="result-actions">
                            <button class="btn-small waves-effect" onclick="copyResult(${index})">
                                <i class="material-icons left">content_copy</i>Copy
                            </button>
                            <button class="btn-small waves-effect" onclick="useAsInput(${index})">
                                <i class="material-icons left">input</i>Use as Input
                            </button>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });

            // Initialize Materialize selects
            M.FormSelect.init(document.querySelectorAll('select'));
            
            // Load and render snippets for sandbox routes
            routes.forEach((route, index) => {
                const isSandbox = route.path.startsWith('/sandbox/');
                if (isSandbox) {
                    const language = route.path.split('/').pop();
                    renderSnippetsList(index, language);
                }
            });
        }

        // Call a route
        async function callRoute(event, index, path, isSandbox = false) {
            event.preventDefault();

            const form = event.target;
            const inputs = form.querySelectorAll('[data-param]');
            const params = new URLSearchParams();

            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    // Special handling for 'mask' parameter - inverted logic
                    if (input.dataset.param === 'mask') {
                        // When 'Remove mask' is checked, send mask=false
                        if (input.checked) {
                            params.append('mask', 'false');
                        }
                        // When unchecked, don't send mask param (backend defaults to true)
                    } else {
                        // For other checkboxes, send 'true' if checked
                        if (input.checked) {
                            params.append(input.dataset.param, 'true');
                        }
                    }
                } else {
                    const value = input.value.trim();
                    if (value) {
                        params.append(input.dataset.param, value);
                    }
                }
            });

            const url = params.toString() ? `${path}?${params.toString()}` : path;

            // Show spinner
            const spinner = document.getElementById(`spinner-${index}`);
            spinner.classList.add('active', 'show');

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                const resultContainer = document.getElementById(`result-${index}`);
                const resultBox = document.getElementById(`result-box-${index}`);
                
                // Format output based on whether it's a sandbox route
                if (isSandbox) {
                    resultBox.innerHTML = formatSandboxOutput(data);
                } else {
                    resultBox.textContent = JSON.stringify(data, null, 2);
                }
                
                resultBox.classList.remove('error');
                
                if (!response.ok || (isSandbox && !data.success)) {
                    resultBox.classList.add('error');
                }
                
                resultContainer.classList.add('show');

                // Add to history
                addToHistory(url, data);

            } catch (error) {
                const resultContainer = document.getElementById(`result-${index}`);
                const resultBox = document.getElementById(`result-box-${index}`);
                
                resultBox.textContent = `Error: ${error.message}`;
                resultBox.classList.add('error');
                resultContainer.classList.add('show');
            } finally {
                spinner.classList.remove('active', 'show');
            }
        }

        // Format sandbox execution output
        function formatSandboxOutput(data) {
            const statusIcon = data.success ? '‚úÖ' : '‚ùå';
            const statusText = data.success ? 'Success' : 'Failed';
            const statusColor = data.success ? '#4caf50' : '#f44336';
            
            let html = `
                <div style="margin-bottom: 15px; padding: 10px; background: ${data.success ? '#e8f5e9' : '#ffebee'}; border-left: 4px solid ${statusColor};">
                    <strong>${statusIcon} ${statusText}</strong>
                    ${data.timeout ? '<span style="color: #ff9800; margin-left: 10px;">‚è±Ô∏è Timeout</span>' : ''}
                    <span style="float: right; color: #666;">‚è± ${data.executionTime}</span>
                </div>
            `;

            if (data.phase) {
                html += `<div style="margin-bottom: 10px;"><strong>Phase:</strong> ${data.phase}</div>`;
            }

            if (data.stdout && data.stdout.trim()) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #2196f3;">üì§ Output:</strong>
                        <pre style="background: #263238; color: #aed581; padding: 12px; border-radius: 4px; margin-top: 5px; overflow-x: auto;">${escapeHtml(data.stdout)}</pre>
                    </div>
                `;
            }

            if (data.stderr && data.stderr.trim()) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #f44336;">‚ö†Ô∏è Error Output:</strong>
                        <pre style="background: #263238; color: #ef5350; padding: 12px; border-radius: 4px; margin-top: 5px; overflow-x: auto;">${escapeHtml(data.stderr)}</pre>
                    </div>
                `;
            }

            if (data.output && !data.stdout && !data.stderr) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <strong>Output:</strong>
                        <pre style="background: #263238; color: #fff; padding: 12px; border-radius: 4px; margin-top: 5px; overflow-x: auto;">${escapeHtml(data.output)}</pre>
                    </div>
                `;
            }

            html += `<div style="font-size: 0.85em; color: #666;"><strong>Exit Code:</strong> ${data.exitCode}</div>`;

            return html;
        }

        // Helper to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Copy result to clipboard
        function copyResult(index) {
            const resultBox = document.getElementById(`result-box-${index}`);
            const text = resultBox.textContent;

            navigator.clipboard.writeText(text).then(() => {
                M.toast({html: 'Copied to clipboard!', classes: 'rounded'});
            }).catch(err => {
                M.toast({html: 'Failed to copy', classes: 'rounded red'});
            });
        }

        // Use result as input in another field
        let lastResult = null;
        function useAsInput(index) {
            const resultBox = document.getElementById(`result-box-${index}`);
            try {
                lastResult = JSON.parse(resultBox.textContent);
                
                // Extract the main value from common result keys
                let value = '';
                if (lastResult.encoded) value = lastResult.encoded;
                else if (lastResult.decoded) value = lastResult.decoded;
                else if (lastResult.cpf) value = lastResult.cpf;
                else if (lastResult.cnpj) value = lastResult.cnpj;
                else if (lastResult.title) value = lastResult.title;
                else if (lastResult.valid !== undefined) value = lastResult.valid.toString();
                else value = JSON.stringify(lastResult);

                // Copy to clipboard and show toast
                navigator.clipboard.writeText(value).then(() => {
                    M.toast({html: `Value "${value.substring(0, 30)}${value.length > 30 ? '...' : ''}" copied! Paste it in any input field.`, classes: 'rounded', displayLength: 4000});
                });

            } catch (e) {
                M.toast({html: 'Could not parse result', classes: 'rounded red'});
            }
        }

        // Add to history
        function addToHistory(path, data) {
            resultHistory.unshift({ path, data, timestamp: new Date() });
            if (resultHistory.length > MAX_HISTORY) {
                resultHistory.pop();
            }
            renderHistory();
        }

        // Render history
        function renderHistory() {
            const panel = document.getElementById('history-panel');
            const list = document.getElementById('history-list');

            if (resultHistory.length === 0) {
                panel.style.display = 'none';
                return;
            }

            panel.style.display = 'block';
            list.innerHTML = '';

            resultHistory.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.onclick = () => {
                    navigator.clipboard.writeText(JSON.stringify(item.data, null, 2));
                    M.toast({html: 'Result copied!', classes: 'rounded'});
                };

                const resultPreview = JSON.stringify(item.data).substring(0, 50);
                div.innerHTML = `
                    <div class="history-path">${item.path}</div>
                    <div class="history-result">${resultPreview}${resultPreview.length >= 50 ? '...' : ''}</div>
                `;
                list.appendChild(div);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            M.AutoInit();
            
            // Load category from URL hash if present
            loadCategoryFromHash();
        });

        // Save code snippet to localStorage
        function saveSnippet(index, language) {
            const textarea = document.querySelector(`#route-${index} textarea[data-param="code"]`);
            if (!textarea || !textarea.value.trim()) {
                M.toast({html: 'No code to save!', classes: 'rounded orange'});
                return;
            }
            
            const code = textarea.value;
            
            // Prompt for tags
            const tagsInput = prompt('Enter tags for this snippet (comma-separated):', '');
            if (tagsInput === null) return; // User cancelled
            
            const tags = tagsInput.split(',').map(t => t.trim()).filter(t => t);
            
            // Get existing snippets
            const snippets = getSnippets(language);
            
            // Add new snippet with timestamp
            snippets.push({
                id: Date.now(),
                code: code,
                tags: tags,
                timestamp: new Date().toISOString()
            });
            
            // Save to localStorage
            localStorage.setItem(`sandbox-snippets-${language}`, JSON.stringify(snippets));
            
            M.toast({html: `${language} snippet saved with ${tags.length} tag(s)!`, classes: 'rounded green'});
            
            // Refresh snippets list
            renderSnippetsList(index, language);
        }

        // Get snippets for a language
        function getSnippets(language) {
            const stored = localStorage.getItem(`sandbox-snippets-${language}`);
            return stored ? JSON.parse(stored) : [];
        }

        // Clear textarea only
        function clearTextarea(index) {
            const textarea = document.querySelector(`#route-${index} textarea[data-param="code"]`);
            if (textarea) {
                textarea.value = '';
                M.toast({html: 'Textarea cleared!', classes: 'rounded'});
            }
        }

        // Toggle snippets section
        function toggleSnippets(index) {
            const list = document.getElementById(`snippets-list-${index}`);
            const icon = document.getElementById(`snippets-toggle-${index}`);
            
            if (list.style.display === 'none') {
                list.style.display = 'block';
                icon.textContent = 'expand_less';
            } else {
                list.style.display = 'none';
                icon.textContent = 'expand_more';
            }
        }

        // Render snippets list
        function renderSnippetsList(index, language) {
            const listContainer = document.getElementById(`snippets-list-${index}`);
            if (!listContainer) return;
            
            const snippets = getSnippets(language);
            
            if (snippets.length === 0) {
                listContainer.innerHTML = '<div style="color: #999; font-style: italic; padding: 10px;">No saved snippets yet</div>';
                return;
            }
            
            listContainer.innerHTML = '';
            
            snippets.reverse().forEach((snippet) => {
                const div = document.createElement('div');
                div.className = 'snippet-item';
                div.style.cssText = 'border: 1px solid #e0e0e0; border-radius: 4px; padding: 10px; margin-bottom: 8px; background: white;';
                
                const date = new Date(snippet.timestamp).toLocaleString();
                const tagsHtml = snippet.tags.length > 0 
                    ? snippet.tags.map(tag => `<span style="background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 3px; font-size: 0.85em; margin-right: 4px;">${tag}</span>`).join('')
                    : '<span style="color: #999; font-style: italic;">no tags</span>';
                
                const codePreview = snippet.code.substring(0, 60) + (snippet.code.length > 60 ? '...' : '');
                
                div.innerHTML = `
                    <div style="margin-bottom: 5px;">
                        ${tagsHtml}
                        <span style="float: right; color: #999; font-size: 0.8em;">${date}</span>
                    </div>
                    <div style="font-family: monospace; font-size: 0.85em; color: #555; margin-bottom: 8px;">${escapeHtml(codePreview)}</div>
                    <div>
                        <button class="btn-small waves-effect blue" onclick="loadSnippet(${index}, ${snippet.id}, '${language}')" style="margin-right: 5px;">
                            <i class="material-icons left" style="font-size: 16px;">input</i>Load
                        </button>
                        <button class="btn-small waves-effect red" onclick="deleteSnippet(${index}, ${snippet.id}, '${language}')">
                            <i class="material-icons left" style="font-size: 16px;">delete</i>Delete
                        </button>
                    </div>
                `;
                
                listContainer.appendChild(div);
            });
        }

        // Load a snippet into the textarea
        function loadSnippet(index, snippetId, language) {
            const snippets = getSnippets(language);
            const snippet = snippets.find(s => s.id === snippetId);
            
            if (snippet) {
                const textarea = document.querySelector(`#route-${index} textarea[data-param="code"]`);
                if (textarea) {
                    textarea.value = snippet.code;
                    M.textareaAutoResize(textarea);
                    M.toast({html: 'Snippet loaded!', classes: 'rounded green'});
                    
                    // Auto-collapse the snippets section
                    const list = document.getElementById(`snippets-list-${index}`);
                    const icon = document.getElementById(`snippets-toggle-${index}`);
                    if (list && icon) {
                        list.style.display = 'none';
                        icon.textContent = 'expand_more';
                    }
                }
            }
        }

        // Delete a snippet
        function deleteSnippet(index, snippetId, language) {
            if (!confirm('Are you sure you want to delete this snippet?')) return;
            
            let snippets = getSnippets(language);
            snippets = snippets.filter(s => s.id !== snippetId);
            
            localStorage.setItem(`sandbox-snippets-${language}`, JSON.stringify(snippets));
            M.toast({html: 'Snippet deleted!', classes: 'rounded'});
            
            renderSnippetsList(index, language);
        }

        // Clear code snippet from localStorage and textarea
        function clearSnippet(index, language) {
            const textarea = document.querySelector(`#route-${index} textarea[data-param="code"]`);
            if (textarea) {
                textarea.value = '';
                localStorage.removeItem(`sandbox-${language}`);
                M.toast({html: `${language} snippet cleared!`, classes: 'rounded'});
            }
        }
    </script>
</body>
</html>
