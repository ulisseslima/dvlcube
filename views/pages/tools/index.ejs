<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Developer Tools | DVLCube</title>
    <!-- Materialize CSS -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/tools.css">
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-wrapper">
            <a href="/" class="brand-logo" style="margin-left: 20px;">
                <i class="material-icons">build</i>
                DVLCube Tools
            </a>
            <ul id="nav-mobile" class="right hide-on-med-and-down">
                <li><a href="/">Home</a></li>
                <li><a href="https://github.com/dvlcube" target="_blank"><i class="material-icons left">code</i>GitHub</a></li>
            </ul>
        </div>
    </nav>

    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <ul class="collection">
                <% for (const [key, category] of Object.entries(routeMetadata)) { %>
                <li class="collection-item" data-category="<%= key %>" onclick="selectCategory('<%= key %>')">
                    <div class="valign-wrapper">
                        <i class="material-icons category-icon"><%= category.icon %></i>
                        <div>
                            <span class="category-name"><%= category.name %></span>
                            <span class="category-desc"><%= category.description %></span>
                        </div>
                    </div>
                </li>
                <% } %>
            </ul>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <div class="tools-panel">
                <!-- Welcome Panel (shown when no category selected) -->
                <div id="welcome-panel" class="welcome-panel">
                    <i class="material-icons large-icon">handyman</i>
                    <h4>Welcome to Developer Tools</h4>
                    <p>Select a category from the sidebar to get started. Each tool allows you to generate, validate, or encode data quickly and easily.</p>
                </div>

                <!-- Dynamic Content Area -->
                <div id="tools-content" style="display: none;">
                    <div class="category-header">
                        <h4 id="category-title"><i class="material-icons" id="category-icon"></i><span id="category-name"></span></h4>
                        <p id="category-description"></p>
                    </div>
                    <div id="routes-container"></div>
                </div>
            </div>

            <!-- Ad Sidebar -->
            <div class="ad-sidebar">
                <div class="ad-container">
                    <div class="ad-placeholder large">
                        <span>Ad Space<br>300 x 250</span>
                    </div>
                </div>
                <div class="ad-container">
                    <div class="ad-placeholder banner">
                        <span>Ad Space - 300 x 90</span>
                    </div>
                </div>
                
                <!-- History Panel -->
                <div class="history-panel" id="history-panel" style="display: none;">
                    <h6><i class="material-icons">history</i>Recent Results</h6>
                    <div class="history-list" id="history-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Materialize JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    
    <script>
        // Route metadata from server (embedded as JSON string and parsed at runtime)
        const routeMetadata = JSON.parse('<%- JSON.stringify(routeMetadata) %>');
        
        // History storage
        let resultHistory = [];
        const MAX_HISTORY = 10;

        // Select a category
        function selectCategory(categoryKey) {
            const category = routeMetadata[categoryKey];
            if (!category) return;

            // Update sidebar active state
            document.querySelectorAll('.sidebar .collection-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-category="${categoryKey}"]`).classList.add('active');

            // Show tools content
            document.getElementById('welcome-panel').style.display = 'none';
            document.getElementById('tools-content').style.display = 'block';

            // Update header
            document.getElementById('category-icon').textContent = category.icon;
            document.getElementById('category-name').textContent = category.name;
            document.getElementById('category-description').textContent = category.description;

            // Render routes
            renderRoutes(category.routes);
        }

        // Render route cards
        function renderRoutes(routes) {
            const container = document.getElementById('routes-container');
            container.innerHTML = '';

            routes.forEach((route, index) => {
                const card = document.createElement('div');
                card.className = 'route-card';
                card.id = `route-${index}`;

                let paramsHtml = '';
                route.params.forEach(param => {
                    if (param.type === 'select') {
                        paramsHtml += `
                            <div class="input-field">
                                <select id="param-${index}-${param.name}" data-param="${param.name}">
                                    ${param.options.map(opt => `<option value="${opt}" ${opt === param.default ? 'selected' : ''}>${opt}</option>`).join('')}
                                </select>
                                <label>${param.name}${param.required ? ' *' : ''}</label>
                            </div>
                        `;
                    } else if (param.type === 'textarea') {
                        paramsHtml += `
                            <div class="input-field">
                                <textarea id="param-${index}-${param.name}" class="materialize-textarea" data-param="${param.name}" placeholder="${param.placeholder || ''}" ${param.required ? 'required' : ''}></textarea>
                                <label for="param-${index}-${param.name}">${param.name}${param.required ? ' *' : ''}</label>
                            </div>
                        `;
                    } else if (param.type === 'checkbox') {
                        const checkedAttr = param.default === true ? 'checked' : '';
                        paramsHtml += `
                            <p>
                                <label>
                                    <input type="checkbox" id="param-${index}-${param.name}" data-param="${param.name}" ${checkedAttr} />
                                    <span>${param.label || param.name}</span>
                                </label>
                            </p>
                        `;
                    } else {
                        paramsHtml += `
                            <div class="input-field">
                                <input type="text" id="param-${index}-${param.name}" data-param="${param.name}" placeholder="${param.placeholder || ''}" ${param.required ? 'required' : ''}>
                                <label for="param-${index}-${param.name}">${param.name}${param.required ? ' *' : ''}</label>
                            </div>
                        `;
                    }
                });

                card.innerHTML = `
                    <h5>${route.name}</h5>
                    <p class="route-description">${route.description}</p>
                    <div class="route-path">${route.method} ${route.path}</div>
                    <form onsubmit="callRoute(event, ${index}, '${route.path}')">
                        ${paramsHtml}
                        <button type="submit" class="btn waves-effect waves-light">
                            <i class="material-icons left">send</i>
                            Execute
                            <div class="preloader-wrapper small loading-spinner" id="spinner-${index}">
                                <div class="spinner-layer spinner-white-only">
                                    <div class="circle-clipper left"><div class="circle"></div></div>
                                </div>
                            </div>
                        </button>
                    </form>
                    <div class="result-container" id="result-${index}">
                        <div class="result-box" id="result-box-${index}"></div>
                        <div class="result-actions">
                            <button class="btn-small waves-effect" onclick="copyResult(${index})">
                                <i class="material-icons left">content_copy</i>Copy
                            </button>
                            <button class="btn-small waves-effect" onclick="useAsInput(${index})">
                                <i class="material-icons left">input</i>Use as Input
                            </button>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });

            // Initialize Materialize selects
            M.FormSelect.init(document.querySelectorAll('select'));
        }

        // Call a route
        async function callRoute(event, index, path) {
            event.preventDefault();

            const form = event.target;
            const inputs = form.querySelectorAll('[data-param]');
            const params = new URLSearchParams();

            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    // Special handling for 'mask' parameter - inverted logic
                    if (input.dataset.param === 'mask') {
                        // When 'Remove mask' is checked, send mask=false
                        if (input.checked) {
                            params.append('mask', 'false');
                        }
                        // When unchecked, don't send mask param (backend defaults to true)
                    } else {
                        // For other checkboxes, send 'true' if checked
                        if (input.checked) {
                            params.append(input.dataset.param, 'true');
                        }
                    }
                } else {
                    const value = input.value.trim();
                    if (value) {
                        params.append(input.dataset.param, value);
                    }
                }
            });

            const url = params.toString() ? `${path}?${params.toString()}` : path;

            // Show spinner
            const spinner = document.getElementById(`spinner-${index}`);
            spinner.classList.add('active', 'show');

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                const resultContainer = document.getElementById(`result-${index}`);
                const resultBox = document.getElementById(`result-box-${index}`);
                
                resultBox.textContent = JSON.stringify(data, null, 2);
                resultBox.classList.remove('error');
                
                if (!response.ok) {
                    resultBox.classList.add('error');
                }
                
                resultContainer.classList.add('show');

                // Add to history
                addToHistory(url, data);

            } catch (error) {
                const resultContainer = document.getElementById(`result-${index}`);
                const resultBox = document.getElementById(`result-box-${index}`);
                
                resultBox.textContent = `Error: ${error.message}`;
                resultBox.classList.add('error');
                resultContainer.classList.add('show');
            } finally {
                spinner.classList.remove('active', 'show');
            }
        }

        // Copy result to clipboard
        function copyResult(index) {
            const resultBox = document.getElementById(`result-box-${index}`);
            const text = resultBox.textContent;

            navigator.clipboard.writeText(text).then(() => {
                M.toast({html: 'Copied to clipboard!', classes: 'rounded'});
            }).catch(err => {
                M.toast({html: 'Failed to copy', classes: 'rounded red'});
            });
        }

        // Use result as input in another field
        let lastResult = null;
        function useAsInput(index) {
            const resultBox = document.getElementById(`result-box-${index}`);
            try {
                lastResult = JSON.parse(resultBox.textContent);
                
                // Extract the main value from common result keys
                let value = '';
                if (lastResult.encoded) value = lastResult.encoded;
                else if (lastResult.decoded) value = lastResult.decoded;
                else if (lastResult.cpf) value = lastResult.cpf;
                else if (lastResult.cnpj) value = lastResult.cnpj;
                else if (lastResult.title) value = lastResult.title;
                else if (lastResult.valid !== undefined) value = lastResult.valid.toString();
                else value = JSON.stringify(lastResult);

                // Copy to clipboard and show toast
                navigator.clipboard.writeText(value).then(() => {
                    M.toast({html: `Value "${value.substring(0, 30)}${value.length > 30 ? '...' : ''}" copied! Paste it in any input field.`, classes: 'rounded', displayLength: 4000});
                });

            } catch (e) {
                M.toast({html: 'Could not parse result', classes: 'rounded red'});
            }
        }

        // Add to history
        function addToHistory(path, data) {
            resultHistory.unshift({ path, data, timestamp: new Date() });
            if (resultHistory.length > MAX_HISTORY) {
                resultHistory.pop();
            }
            renderHistory();
        }

        // Render history
        function renderHistory() {
            const panel = document.getElementById('history-panel');
            const list = document.getElementById('history-list');

            if (resultHistory.length === 0) {
                panel.style.display = 'none';
                return;
            }

            panel.style.display = 'block';
            list.innerHTML = '';

            resultHistory.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.onclick = () => {
                    navigator.clipboard.writeText(JSON.stringify(item.data, null, 2));
                    M.toast({html: 'Result copied!', classes: 'rounded'});
                };

                const resultPreview = JSON.stringify(item.data).substring(0, 50);
                div.innerHTML = `
                    <div class="history-path">${item.path}</div>
                    <div class="history-result">${resultPreview}${resultPreview.length >= 50 ? '...' : ''}</div>
                `;
                list.appendChild(div);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            M.AutoInit();
        });
    </script>
</body>
</html>
